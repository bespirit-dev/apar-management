<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Reset Password</title>

<!-- Favicon Logo Admin -->
<link rel="icon" href="secure.png" type="image/png">

<!-- Google Fonts & Bootstrap Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #0b1e70, #0cd8b6);
    margin: 0;
    padding: 40px;
    color: #333;
  }

  .admin-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 25px;
    background: rgba(255,255,255,0.95);
    padding: 12px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .admin-logo { height: 50px; }
  .admin-title { font-size: 22px; font-weight: 700; color: #0b1e70; }

  h2 { text-align: center; color: #fff; font-size: 26px; margin-bottom: 20px; }

  table {
    border-collapse: collapse;
    width: 100%;
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    animation: fadeIn 0.5s ease;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
  th, td { padding: 12px; text-align: center; font-size: 14px; }
  th { background: #0b1e70; color: #fff; font-weight: 600; text-transform: uppercase; }
  tr:nth-child(even) { background: #f9f9f9; }
  tr:hover { background: #eef7f6; }

  button.reset, button.delete {
    padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer;
    font-weight: 600; transition: 0.3s; display: inline-flex; align-items: center; gap: 6px; margin: 2px;
  }
  button.reset { background: #c9302c; color: #fff; }
  button.reset:hover { background: #d9534f; transform: scale(1.05); }
  button.delete { background: #6c757d; color: #fff; }
  button.delete:hover { background: #5a6268; transform: scale(1.05); }

  .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; color: #fff; }
  .status-pending { background: #f0ad4e; }
  .status-done { background: #5cb85c; }

  .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  .modal-content {
    background: #fff; padding: 20px 30px; border-radius: 12px; width: 350px; text-align: center;
    box-shadow: 0 6px 20px rgba(0,0,0,0.25); animation: slideDown 0.4s ease; position: relative;
  }
  @keyframes slideDown { from { transform: translateY(-20px); opacity: 0;} to { transform: translateY(0); opacity: 1;} }
  .modal-content h3 { margin-bottom: 10px; color: #0b1e70; }
  .modal-content .icon { font-size: 40px; color: #0cd8b6; margin-bottom: 10px; }
  .modal-content input { width: 100%; padding: 10px; margin: 12px 0; border: 1px solid #ccc; border-radius: 8px; }
  .modal-actions { display: flex; justify-content: space-between; gap: 10px; }
  .modal-actions button { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; }
  #confirmReset { background: #0cd8b6; color: #fff; }
  #confirmReset:hover { background: #0de6c5; }
  #cancelReset { background: #6c757d; color: #fff; }
  #cancelReset:hover { background: #5a6268; }
  .close { position: absolute; right: 15px; top: 10px; font-size: 20px; cursor: pointer; }

  @media (max-width: 768px) {
    body { padding: 20px; }
    .admin-header { flex-direction: column; text-align: center; }
    .admin-logo { height: 40px; margin-bottom: 8px; }
    .admin-title { font-size: 18px; }
    h2 { font-size: 20px; }
    table, thead, tbody, th, td, tr { display: block; width: 100%; }
    thead { display: none; }
    tr { margin-bottom: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 10px; }
    td { text-align: left; padding: 8px; border: none; position: relative; }
    td::before { content: attr(data-label); font-weight: 600; display: block; margin-bottom: 4px; color: #0b1e70; }
    button.reset, button.delete { width: 100%; justify-content: center; margin-top: 6px; }
  }
</style>
</head>
<body>

<h2>üìã Daftar Permintaan Reset Password</h2>
<table>
  <thead>
    <tr>
      <th>NPK</th>
      <th>Username</th>
      <th>Time Request</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="resetTable"></tbody>
</table>

<!-- Modal Reset Password -->
<div id="resetModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div class="icon"><i class="bi bi-shield-lock-fill"></i></div>
    <h3>Reset Password</h3>
    <p id="modalNPK"></p>
    <input type="password" id="newPassword" placeholder="Masukkan password baru">
    <div class="modal-actions">
      <button id="confirmReset">Konfirmasi</button>
      <button id="cancelReset">Batal</button>
    </div>
  </div>
</div>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  (function(){
    emailjs.init("suTM_3MTwn6Ou-pbC"); // ganti dengan public key dari EmailJS
  })();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
  import { getDatabase, ref, get, update, remove } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAoZPIGUuCZxosN5m2LFirk9Spf7c9QZrA",
    authDomain: "be-spirit-project.firebaseapp.com",
    databaseURL: "https://be-spirit-project-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "be-spirit-project",
    storageBucket: "be-spirit-project.appspot.com",
    messagingSenderId: "518798108329",
    appId: "1:518798108329:web:f3a64e05dbb1c20751ebb8",
    measurementId: "G-55M6SPB3QM",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // Proteksi admin
  onAuthStateChanged(auth, (user) => {
    if (!user || localStorage.getItem("isAdmin") !== "true") {
      alert("‚ö†Ô∏è Anda harus login sebagai administrator!");
      window.location.href = "admin-login.html";
    }
  });

  let currentNPK = null;
  let requestsData = {}; // simpan data global

  async function loadRequests(){
    const snapshot = await get(ref(db, "resetRequests"));
    const table = document.getElementById("resetTable");
    table.innerHTML = "";

    if(snapshot.exists()){
      requestsData = snapshot.val(); // simpan data agar bisa dipakai di luar
      for(let npk in requestsData){
        const row = document.createElement("tr");
        const statusClass = requestsData[npk].status === "done" ? "status-done" : "status-pending";

        row.innerHTML = `
          <td data-label="NPK">${npk}</td>
          <td data-label="Username">${requestsData[npk].username || "-"}</td>
          <td data-label="Waktu Request">${requestsData[npk].requestedAt}</td>
          <td data-label="Status"><span class="status-badge ${statusClass}">${requestsData[npk].status}</span></td>
          <td data-label="Aksi">
            <button class="reset"><i class="bi bi-key-fill"></i> Reset</button>
            <button class="delete"><i class="bi bi-trash-fill"></i> Delete</button>
          </td>
        `;

        // Reset password ‚Üí buka modal
        row.querySelector("button.reset").onclick = () => {
          currentNPK = npk;
          document.getElementById("modalNPK").textContent = `NPK: ${npk}`;
          document.getElementById("resetModal").style.display = "flex";
        };

        // Delete request
        row.querySelector("button.delete").onclick = async () => {
          if(confirm(`Apakah Anda yakin ingin menghapus request NPK ${npk}?`)){
            await remove(ref(db, `resetRequests/${npk}`));
            alert(`üóëÔ∏è Request NPK ${npk} berhasil dihapus.`);
            loadRequests();
          }
        };

        table.appendChild(row);
      }
    } else {
      table.innerHTML = `<tr><td colspan="5">Tidak ada permintaan reset.</td></tr>`;
    }
  }

  // Modal actions
  document.getElementById("confirmReset").onclick = async () => {
    const newPass = document.getElementById("newPassword").value.trim();
    if(!newPass){
      alert("‚ùå Password tidak boleh kosong!");
      return;
    }
    if(newPass.length < 8){
      alert("‚ö†Ô∏è Password minimal 8 karakter!");
      return;
    }

    // Update password di Firebase
    await update(ref(db, `users/${currentNPK}`), { password: newPass, status: "active" });
    await update(ref(db, `resetRequests/${currentNPK}`), { status: "done" });

    // Kirim email ke requester ‚Üí ambil dari node users
const userSnap = await get(ref(db, `users/${currentNPK}`));
if(userSnap.exists()){
  const userData = userSnap.val();
  const requesterEmail = userData.email;

  if(requesterEmail){
    emailjs.send("service_uix6wsl","template_8ik4w2l",{
      to_email: requesterEmail,
      npk: currentNPK,
      username: userData.username,
      new_password: newPass
        }).then(() => {
          alert(`‚úÖ Password NPK ${currentNPK} berhasil direset & email notifikasi terkirim.`);
        }).catch((err) => {
          console.error("EmailJS error detail:", err);
          alert("‚ö†Ô∏è Password berhasil direset, tapi email gagal dikirim. Lihat console untuk detail error.");
        });
      } else {
        alert(`‚úÖ Password NPK ${currentNPK} berhasil direset. (Email requester tidak ditemukan di users)`);
      }
    } else {
      alert(`‚úÖ Password NPK ${currentNPK} berhasil direset. (Data user tidak ditemukan di users)`);
    }

    document.getElementById("resetModal").style.display = "none";
    document.getElementById("newPassword").value = "";
    loadRequests();

      };

  document.getElementById("cancelReset").onclick = () => {
    document.getElementById("resetModal").style.display = "none";
    document.getElementById("newPassword").value = "";
  };

  document.querySelector(".close").onclick = () => {
    document.getElementById("resetModal").style.display = "none";
    document.getElementById("newPassword").value = "";
  };

  loadRequests();
</script>
</body>
</html>
